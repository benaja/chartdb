import{r,j as e,S as dt,R as X,b as V,g as lt,T as G,e as W,f as U,q as ke,p as ct}from"./index-4Cz_Moiq.js";import{d as ae,u as Ie,e as ht,b as de,f as pt,g as Pe,P as q,h as Te,i as ut,j as mt,k as Ve,c as Ne,l as ft,m as gt,n as $e,o as xt,p as bt,q as yt,r as ze,s as jt,t as Tt,T as vt,v as kt,w as Ct,M as wt,x as It,y as Nt,L as St,z as Rt,A as Fe,B as Et,D as _t,E as re,F as Ot,G as Mt,H as He,I as we,J as Dt,K as Lt,N as ge,O as zt,Q as Ft,S as Ht,U as At,V as Bt}from"./canvas-utils-Dtqfc-zs.js";import{B as te}from"./label-D_EewkRs.js";import{c as J,k as xe,K as be,u as Ze}from"./theme-provider-BDcPqgZH.js";import{B as Pt}from"./badge-BKwMgpMr.js";import{u as Vt}from"./databases-BNVpV01H.js";import{D as $t}from"./database-type-C2NNW5SW.js";/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zt=J("Magnet",[["path",{d:"m6 15-4-4 6.75-6.77a7.79 7.79 0 0 1 11 11L13 22l-4-4 6.39-6.36a2.14 2.14 0 0 0-3-3L6 15",key:"1i3lhw"}],["path",{d:"m5 8 4 4",key:"j6kj7e"}],["path",{d:"m12 15 4 4",key:"lnac28"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gt=J("Redo",[["path",{d:"M21 7v6h-6",key:"3ptur4"}],["path",{d:"M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7",key:"1kgawr"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wt=J("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ut=J("Scan",[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=J("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kt=J("Undo",[["path",{d:"M3 7v6h6",key:"1v2h90"}],["path",{d:"M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13",key:"1r6uu6"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qt=J("ZoomIn",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);/**
 * @license lucide-react v0.441.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xt=J("ZoomOut",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);var Jt=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","span","svg","ul"],Qt=Jt.reduce((o,s)=>{const t=r.forwardRef((c,l)=>{const{asChild:h,...f}=c,u=h?dt:s;return typeof window<"u"&&(window[Symbol.for("radix-ui")]=!0),e.jsx(u,{...f,ref:l})});return t.displayName=`Primitive.${s}`,{...o,[s]:t}},{}),es="Separator",Ae="horizontal",ts=["horizontal","vertical"],Ge=r.forwardRef((o,s)=>{const{decorative:t,orientation:c=Ae,...l}=o,h=ss(c)?c:Ae,u=t?{role:"none"}:{"aria-orientation":h==="vertical"?h:void 0,role:"separator"};return e.jsx(Qt.div,{"data-orientation":h,...u,...l,ref:s})});Ge.displayName=es;function ss(o){return ts.includes(o)}var We=Ge;const je=X.forwardRef(({className:o,orientation:s="horizontal",decorative:t=!0,...c},l)=>e.jsx(We,{ref:l,decorative:t,orientation:s,className:V("shrink-0 bg-border",s==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",o),...c}));je.displayName=We.displayName;var os=function o(s,t){if(s===t)return!0;if(s&&t&&typeof s=="object"&&typeof t=="object"){if(s.constructor!==t.constructor)return!1;var c,l,h;if(Array.isArray(s)){if(c=s.length,c!=t.length)return!1;for(l=c;l--!==0;)if(!o(s[l],t[l]))return!1;return!0}if(s.constructor===RegExp)return s.source===t.source&&s.flags===t.flags;if(s.valueOf!==Object.prototype.valueOf)return s.valueOf()===t.valueOf();if(s.toString!==Object.prototype.toString)return s.toString()===t.toString();if(h=Object.keys(s),c=h.length,c!==Object.keys(t).length)return!1;for(l=c;l--!==0;)if(!Object.prototype.hasOwnProperty.call(t,h[l]))return!1;for(l=c;l--!==0;){var f=h[l];if(!o(s[f],t[f]))return!1}return!0}return s!==s&&t!==t};const ye=lt(os),as=({id:o,sourceX:s,sourceY:t,targetX:c,targetY:l,source:h,target:f,selected:u,data:N})=>{var M,D;const{getInternalNode:O,getEdge:y}=ae(),{openRelationshipFromSidebar:I,selectSidebarSection:E}=Ie(),{checkIfRelationshipRemoved:S,checkIfNewRelationship:k}=ht(),{relationships:T}=de(),d=N==null?void 0:N.relationship,_=r.useCallback(()=>{E("relationships"),I(o)},[o,I,E]),b=r.useMemo(()=>T.filter(C=>C.targetTableId===f&&C.sourceTableId===h||C.targetTableId===h&&C.sourceTableId===f).findIndex(C=>C.id===o),[T,o,h,f]),w=O(h),v=O(f),A=y(o),B=(D=(M=A==null?void 0:A.sourceHandle)==null?void 0:M.startsWith)!=null&&D.call(M,pt)?"right":"left",m=(w==null?void 0:w.measured.width)??0,L=B==="left"?s+3:s-m-10,z=B==="left"?s+m+9:s,Y=(v==null?void 0:v.measured.width)??0,F=c-1,Z=c+Y+10,{sourceSide:K,targetSide:$}=r.useMemo(()=>{const C={leftToLeft:Math.abs(L-F),leftToRight:Math.abs(L-Z),rightToLeft:Math.abs(z-F),rightToRight:Math.abs(z-Z)},ue=Math.min(C.leftToLeft,C.leftToRight,C.rightToLeft,C.rightToRight);switch(Object.keys(C).find(me=>C[me]===ue)){case"leftToRight":return{sourceSide:"left",targetSide:"right"};case"rightToLeft":return{sourceSide:"right",targetSide:"left"};case"rightToRight":return{sourceSide:"right",targetSide:"right"};default:return{sourceSide:"left",targetSide:"left"}}},[L,z,F,Z]),[le]=r.useMemo(()=>Pe({sourceX:K==="left"?L:z,sourceY:t,targetX:$==="left"?F:Z,targetY:l,borderRadius:14,sourcePosition:K==="left"?q.Left:q.Right,targetPosition:$==="left"?q.Left:q.Right,offset:(b+1)*14}),[K,$,L,z,F,Z,t,l,b]),ce=r.useMemo(()=>Te({cardinality:(d==null?void 0:d.sourceCardinality)??"one",selected:u??!1,side:K}),[d==null?void 0:d.sourceCardinality,u,K]),he=r.useMemo(()=>Te({cardinality:(d==null?void 0:d.targetCardinality)??"one",selected:u??!1,side:$}),[d==null?void 0:d.targetCardinality,u,$]),pe=r.useMemo(()=>d!=null&&d.id?k({relationshipId:d.id}):!1,[k,d==null?void 0:d.id]),se=r.useMemo(()=>d!=null&&d.id?S({relationshipId:d.id}):!1,[S,d==null?void 0:d.id]);return e.jsxs(e.Fragment,{children:[e.jsx("path",{id:o,d:le,markerStart:`url(#${ce})`,markerEnd:`url(#${he})`,fill:"none",className:V(["react-flow__edge-path",`!stroke-2 ${u?"!stroke-pink-600":"!stroke-slate-400"}`,{"!stroke-green-500 !stroke-[3px]":pe,"!stroke-red-500 !stroke-[3px]":se}]),onClick:C=>{C.detail===2&&_()}}),e.jsx("path",{d:le,fill:"none",strokeOpacity:0,strokeWidth:20,className:"react-flow__edge-interaction",onClick:C=>{C.detail===2&&_()}})]})},Ue=X.forwardRef(({className:o,...s},t)=>e.jsx("div",{ref:t,className:V("rounded-xl border bg-card text-card-foreground shadow",o),...s}));Ue.displayName="Card";const ns=X.forwardRef(({className:o,...s},t)=>e.jsx("div",{ref:t,className:V("flex flex-col space-y-1.5 p-6",o),...s}));ns.displayName="CardHeader";const is=X.forwardRef(({className:o,...s},t)=>e.jsx("h3",{ref:t,className:V("font-semibold leading-none tracking-tight",o),...s}));is.displayName="CardTitle";const rs=X.forwardRef(({className:o,...s},t)=>e.jsx("p",{ref:t,className:V("text-sm text-muted-foreground",o),...s}));rs.displayName="CardDescription";const Ye=X.forwardRef(({className:o,...s},t)=>e.jsx("div",{ref:t,className:V("p-6 pt-0",o),...s}));Ye.displayName="CardContent";const ds=X.forwardRef(({className:o,...s},t)=>e.jsx("div",{ref:t,className:V("flex items-center p-6 pt-0",o),...s}));ds.displayName="CardFooter";const ee=X.forwardRef((o,s)=>{const{className:t,...c}=o;return e.jsx(te,{ref:s,variant:"ghost",className:V("w-[36px] p-2 hover:bg-primary-foreground",t),...c})});ee.displayName=te.displayName;const ls=()=>{const{getNodes:o,getViewport:s}=ae(),[t,c]=r.useState(!1),l=r.useCallback(()=>{var d,_;const f=o(),u=s();if(f.length===0){c(!1);return}const N=f.filter(b=>!b.hidden);if(N.length===0){c(!1);return}const O=-u.x/u.zoom,y=-u.y/u.zoom,I=((d=document.getElementById("canvas"))==null?void 0:d.clientWidth)||window.innerWidth,E=((_=document.getElementById("canvas"))==null?void 0:_.clientHeight)||window.innerHeight,S=O+I/u.zoom,k=y+E/u.zoom,T=N.some(b=>{var z;let w=b.width||0,v=b.height||0;if(b.type==="table"&&((z=b.data)!=null&&z.table)){const F=ut(b.data.table);w=F.width,v=F.height}const A=b.position.x,B=b.position.y,m=A+w,L=B+v;return m>=O&&A<=S&&L>=y&&B<=k});c(!T)},[o,s]),h=mt(l,1e3);return Ve({onEnd:()=>{h()}}),{isLostInCanvas:t}},Be=o=>`${Math.round(o*100)}%`,cs=({readonly:o})=>{const{updateDiagramUpdatedAt:s}=de(),{t}=Ne(),{redo:c,undo:l,hasRedo:h,hasUndo:f}=ft(),{getZoom:u,zoomIn:N,zoomOut:O,fitView:y}=ae(),[I,E]=r.useState(Be(u())),{isLostInCanvas:S}=ls();Ve({onChange:({zoom:w})=>{E(Be(w))}});const k=200,T=()=>{N({duration:k})},d=()=>{O({duration:k})},_=()=>{y({minZoom:1,maxZoom:1,duration:k})},b=r.useCallback(()=>{y({duration:500,padding:.1,maxZoom:.8})},[y]);return e.jsx("div",{className:"px-1",children:e.jsx(Ue,{className:"h-[44px] bg-secondary p-0 shadow-none",children:e.jsxs(Ye,{className:"flex h-full flex-row items-center p-1",children:[o?null:e.jsxs(e.Fragment,{children:[e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ee,{onClick:s,children:e.jsx(Wt,{})})})}),e.jsxs(U,{children:[t("toolbar.save"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:xe[be.SAVE_DIAGRAM].keyCombinationLabel})]})]}),e.jsx(je,{orientation:"vertical"})]}),e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ee,{onClick:b,className:S?"bg-pink-500 text-white hover:bg-pink-600 hover:text-white":"",children:e.jsx(Ut,{})})})}),e.jsxs(U,{children:[t("toolbar.show_all"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:xe[be.SHOW_ALL].keyCombinationLabel})]})]}),e.jsx(je,{orientation:"vertical"}),e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ee,{onClick:d,children:e.jsx(Xt,{})})})}),e.jsx(U,{children:t("toolbar.zoom_out")})]}),e.jsx(te,{variant:"ghost",onClick:_,className:"w-[60px] p-2 hover:bg-primary-foreground",children:I}),e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ee,{onClick:T,children:e.jsx(qt,{})})})}),e.jsx(U,{children:t("toolbar.zoom_in")})]}),e.jsx(je,{orientation:"vertical"}),e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ee,{onClick:l,disabled:!f,children:e.jsx(Kt,{})})})}),e.jsxs(U,{children:[t("toolbar.undo"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:xe[be.UNDO].keyCombinationLabel})]})]}),e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(ee,{onClick:c,disabled:!h,children:e.jsx(Gt,{})})})}),e.jsxs(U,{children:[t("toolbar.redo"),e.jsx("span",{className:"ml-2 text-muted-foreground",children:xe[be.REDO].keyCombinationLabel})]})]})]})})})},hs=()=>{const{showCardinality:o}=Ze(),s={one:"1",many:"N"},t=["left","right"],c=[!0,!1];return o?e.jsx("svg",{className:"marker-definitions absolute left-0 top-0 z-0 size-0",children:e.jsx("defs",{children:Object.entries(s).map(([l,h])=>t.map(f=>c.map(u=>e.jsxs("marker",{id:Te({cardinality:l,selected:u,side:f}),viewBox:"0 0 16 16",markerWidth:"16",markerHeight:"16",refX:f==="left"?"15":"1",refY:"8",children:[e.jsx("circle",{cx:"8",cy:"8",r:"5",className:V([u?"fill-pink-600":"fill-muted-foreground","stroke-background","stroke-[0.5]"])}),e.jsx("text",{x:"7.9",y:"8.4",fontSize:"6",fontWeight:"600",textAnchor:"middle",dominantBaseline:"middle",className:"fill-muted",children:h})]},Te({cardinality:l,selected:u,side:f})))))})}):null},ps=({children:o})=>{const{createTable:s,filteredSchemas:t,schemas:c,readonly:l}=de(),{openCreateRelationshipDialog:h,openTableSchemaDialog:f}=gt(),{screenToFlowPosition:u}=ae(),{t:N}=Ne(),{isMd:O}=$e("md"),y=r.useCallback(E=>{var k;const S=u({x:E.clientX,y:E.clientY});if(((t==null?void 0:t.length)??0)>1)f({onConfirm:T=>s({x:S.x,y:S.y,schema:T}),schemas:c.filter(T=>t==null?void 0:t.includes(T.id))});else{const T=(t==null?void 0:t.length)===1?(k=c.find(d=>d.id===t[0]))==null?void 0:k.name:void 0;s({x:S.x,y:S.y,schema:T})}},[s,u,f,c,t]),I=r.useCallback(()=>{h()},[h]);return!O||l?e.jsx(e.Fragment,{children:o}):e.jsxs(xt,{children:[e.jsx(bt,{children:o}),e.jsxs(yt,{children:[e.jsx(ze,{onClick:y,children:N("canvas_context_menu.new_table")}),e.jsx(ze,{onClick:I,children:N("canvas_context_menu.new_relationship")})]})]})},us=({id:o,sourceX:s,sourceY:t,targetX:c,targetY:l,source:h,target:f,selected:u})=>{const{getInternalNode:N}=ae(),{dependencies:O}=de(),{openDependencyFromSidebar:y,selectSidebarSection:I}=Ie(),E=r.useCallback(()=>{I("dependencies"),y(o)},[o,y,I]),S=r.useMemo(()=>O.filter(m=>m.tableId===f&&m.dependentTableId===h||m.tableId===h&&m.dependentTableId===f).findIndex(m=>m.id===o),[O,o,h,f]),k=N(h),T=N(f),{sourceTopY:d,sourceBottomY:_,targetTopY:b,targetBottomY:w}=r.useMemo(()=>{const m=(k==null?void 0:k.measured.height)??0,L=t+5,z=t+m+10,Y=(T==null?void 0:T.measured.height)??0,F=l+1,Z=l+Y+5;return{sourceTopY:L,sourceBottomY:z,targetTopY:F,targetBottomY:Z}},[k==null?void 0:k.measured.height,t,T==null?void 0:T.measured.height,l]),{sourceSide:v,targetSide:A}=r.useMemo(()=>{const m={topToTop:Math.abs(d-b),topToBottom:Math.abs(d-w),bottomToTop:Math.abs(_-b),bottomToBottom:Math.abs(_-w)},L=Math.min(m.topToTop,m.topToBottom,m.bottomToTop,m.bottomToBottom);switch(Object.keys(m).find(Y=>m[Y]===L)){case"topToBottom":return{sourceSide:"top",targetSide:"bottom"};case"bottomToTop":return{sourceSide:"bottom",targetSide:"top"};case"bottomToBottom":return{sourceSide:"bottom",targetSide:"bottom"};default:return{sourceSide:"top",targetSide:"top"}}},[d,_,b,w]),[B]=r.useMemo(()=>Pe({sourceX:s,sourceY:v==="top"?d:_,targetX:c,targetY:A==="top"?b:w,borderRadius:14,sourcePosition:v==="top"?q.Top:q.Bottom,targetPosition:A==="top"?q.Top:q.Bottom,offset:(S+1)*14}),[S,_,v,d,s,w,A,b,c]);return e.jsxs(e.Fragment,{children:[e.jsx("path",{id:o,d:B,fill:"none",className:V(["react-flow__edge-path",`!stroke-2 ${u?"!stroke-pink-600":"!stroke-blue-400"}`]),onClick:m=>{m.detail===2&&E()}}),e.jsx("path",{d:B,fill:"none",strokeOpacity:0,strokeWidth:20,className:"react-flow__edge-interaction",onClick:m=>{m.detail===2&&E()}})]})},ms={"relationship-edge":as,"dependency-edge":us},fs=[],Ce=(o,s)=>({id:o.id,type:"table",position:{x:o.x,y:o.y},data:{table:o,isOverlapping:!1},width:o.width??wt,hidden:!we(o,s)}),ks=({initialTables:o})=>{const{getEdge:s,getInternalNode:t,getEdges:c,getNode:l}=ae(),[h,f]=r.useState([]),[u,N]=r.useState([]),{toast:O}=jt(),{t:y}=Ne(),{tables:I,relationships:E,createRelationship:S,createDependency:k,updateTablesState:T,removeRelationships:d,removeDependencies:_,getField:b,databaseType:w,filteredSchemas:v,events:A,dependencies:B,readonly:m}=de(),{showSidePanel:L}=Ie(),{effectiveTheme:z}=Vt(),{scrollAction:Y,showDependenciesOnCanvas:F,showMiniMapOnCanvas:Z}=Ze(),{showAlert:K}=Tt(),{isMd:$}=$e("md"),le=r.useMemo(()=>({table:vt}),[]),[ce,he]=r.useState(!1),{reorderTables:pe,fitView:se,setOverlapGraph:M,overlapGraph:D}=kt(),[C,ue]=r.useState(!0),[H,me,Se]=Ct(o.map(n=>Ce(n,v))),[ve,fe,Re]=It(fs),[Ee,Ke]=r.useState(!1);r.useEffect(()=>{ue(!0)},[o]),r.useEffect(()=>{const n=o.map(i=>Ce(i,v));ye(n,H)&&ue(!1)},[o,H,v]),r.useEffect(()=>{C||ke(()=>{se({duration:200,padding:.1,maxZoom:.8})},500)()},[C,se]),r.useEffect(()=>{const n=E.reduce((a,g)=>(a[`${g.targetTableId}${g.targetFieldId}`]=0,a),{}),i=B.reduce((a,g)=>(a[g.tableId]=0,a),{});fe([...E.map(a=>({id:a.id,source:a.sourceTableId,target:a.targetTableId,sourceHandle:`${St}${a.sourceFieldId}`,targetHandle:`${Nt}${n[`${a.targetTableId}${a.targetFieldId}`]++}_${a.targetFieldId}`,type:"relationship-edge",data:{relationship:a}})),...B.map(a=>({id:a.id,source:a.dependentTableId,target:a.tableId,sourceHandle:`${Fe}${a.dependentTableId}`,targetHandle:`${Rt}${i[a.tableId]++}_${a.tableId}`,type:"dependency-edge",data:{dependency:a},hidden:!F&&w!==$t.CLICKHOUSE}))])},[E,B,fe,F,w]),r.useEffect(()=>{const n=H.filter(i=>i.selected).map(i=>i.id);ye(n,h)||f(n)},[H,f,h]),r.useEffect(()=>{const n=ve.filter(i=>i.selected).map(i=>i.id);ye(n,u)||N(n)},[ve,N,u]),r.useEffect(()=>{const i=[...c().filter(a=>h.includes(a.source)||h.includes(a.target)).map(a=>a.id),...u];fe(a=>a.map(g=>{const x=i.includes(g.id);if(g.type==="dependency-edge"){const j=g;return{...j,data:{...j.data,highlighted:x},animated:x,zIndex:x?1:0}}else{const j=g;return{...j,data:{...j.data,highlighted:x},animated:x,zIndex:x?1:0}}}))},[u,h,fe,c]),r.useEffect(()=>{me(I.map(n=>{const i=(D.graph.get(n.id)??[]).length>0,a=Ce(n,v);return{...a,data:{...a.data,isOverlapping:i,highlightOverlappingTables:ce}}}))},[I,me,v,D.lastUpdated,D.graph,ce]);const _e=r.useRef(void 0);r.useEffect(()=>{ye(v,_e.current)||(ke(()=>{const n=He({tables:I.filter(i=>we(i,v))});M(n),se({duration:500,padding:.1,maxZoom:.8})},500)(),_e.current=v)},[v,se,I,M]);const qe=r.useCallback(async n=>{var R,P,Q,ne,ie,oe,De,Le;if((P=(R=n.sourceHandle)==null?void 0:R.startsWith)!=null&&P.call(R,Fe)||(ne=(Q=n.sourceHandle)==null?void 0:Q.startsWith)!=null&&ne.call(Q,Et)){const it=n.target,rt=n.source;k({tableId:it,dependentTableId:rt});return}const i=n.source,a=n.target,g=((oe=(ie=n.sourceHandle)==null?void 0:ie.split("_"))==null?void 0:oe.pop())??"",x=((Le=(De=n.targetHandle)==null?void 0:De.split("_"))==null?void 0:Le.pop())??"",j=b(i,g),p=b(a,x);if(!(!j||!p)){if(!_t(j.type,p.type,w)){O({title:"Field types are not compatible",variant:"destructive",description:"Relationships can only be created between compatible field types"});return}S({sourceTableId:i,targetTableId:a,sourceFieldId:g,targetFieldId:x})}},[S,k,b,O,w]),Xe=r.useCallback(n=>{let i=n;m&&(i=i.filter(p=>p.type!=="remove"));const g=i.filter(p=>p.type==="remove").map(p=>s(p.id)).filter(p=>!!p),x=g.filter(p=>(p==null?void 0:p.type)==="relationship-edge").map(p=>{var R,P;return(P=(R=p==null?void 0:p.data)==null?void 0:R.relationship)==null?void 0:P.id}),j=g.filter(p=>(p==null?void 0:p.type)==="dependency-edge").map(p=>{var R,P;return(P=(R=p==null?void 0:p.data)==null?void 0:R.dependency)==null?void 0:P.id});return x.length>0&&d(x),j.length>0&&_(j),Re(i)},[s,Re,d,_,m]),Je=r.useCallback(({positionChanges:n,sizeChanges:i})=>{if(n.length>0||i.length>0){let a=D;for(const g of n)a=re({node:l(g.id)},{nodes:H.filter(x=>!x.hidden)},a);for(const g of i)a=re({node:l(g.id)},{nodes:H.filter(x=>!x.hidden)},a);M(a)}},[H,D,M,l]),Oe=ke(Je,200),Qe=r.useCallback(n=>{let i=n;m&&(i=i.filter(j=>j.type!=="remove"));const a=i.filter(j=>j.type==="position"&&!j.dragging),g=i.filter(j=>j.type==="remove"),x=i.filter(j=>j.type==="dimensions"&&j.resizing);return(a.length>0||g.length>0||x.length>0)&&T(j=>j.map(p=>{var Q,ne,ie;const R=a.find(oe=>oe.id===p.id),P=x.find(oe=>oe.id===p.id);return R||P?{id:p.id,...R?{x:(Q=R.position)==null?void 0:Q.x,y:(ne=R.position)==null?void 0:ne.y}:{},...P?{width:((ie=P.dimensions)==null?void 0:ie.width)??p.width}:{}}:p}).filter(p=>!g.some(R=>R.id===p.id))),Oe({positionChanges:a,sizeChanges:x}),Se(i)},[Se,T,Oe,m]),et=r.useCallback(n=>{let i=D;if(n.action==="add_tables"){for(const a of n.data.tables)i=re({node:l(a.id)},{nodes:H.filter(g=>!g.hidden)},D);M(i)}else if(n.action==="remove_tables"){for(const a of n.data.tableIds)i=Ot(i,a);M(i)}else if(n.action==="update_table"&&n.data.table.width){const a=l(n.data.id),g={...a.measured,width:n.data.table.width};i=re({node:{...a,measured:g}},{nodes:H.filter(x=>!x.hidden)},D),M(i)}else if(n.action==="add_field"||n.action==="remove_field"){const a=l(n.data.tableId),g={...a.measured??{},height:Mt(n.data.fields.length)};i=re({node:{...a,measured:g}},{nodes:H.filter(x=>!x.hidden)},D),M(i)}else if(n.action==="load_diagram"){const a=n.data.diagram.tables??[],g=He({tables:a.filter(x=>we(x,v))});M(g)}},[D,M,l,H,v]);A.useSubscription(et);const tt=I.length>0?!t(I[0].id):!1,st=r.useCallback(()=>{K({title:y("reorder_diagram_alert.title"),description:y("reorder_diagram_alert.description"),actionLabel:y("reorder_diagram_alert.reorder"),closeLabel:y("reorder_diagram_alert.cancel"),onAction:pe})},[y,K,pe]),ot=r.useMemo(()=>Array.from(D.graph).some(([,n])=>n.length>0),[D]),at=r.useCallback(()=>{he(!0),setTimeout(()=>he(!1),600)},[]),Me=Dt("Shift"),nt=ct();return e.jsx(ps,{children:e.jsxs("div",{className:"relative flex h-full",id:"canvas",children:[e.jsxs(Lt,{colorMode:z,className:"canvas-cursor-default nodes-animated",nodes:H,edges:ve,onNodesChange:Qe,onEdgesChange:Xe,maxZoom:5,minZoom:.1,onConnect:qe,proOptions:{hideAttribution:!0},fitView:!1,nodeTypes:le,edgeTypes:ms,defaultEdgeOptions:{animated:!1,type:"relationship-edge"},panOnScroll:Y==="pan",snapToGrid:Me||Ee,snapGrid:[20,20],children:[e.jsx(ge,{position:"top-left",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsxs("div",{className:"flex flex-col items-center gap-2 md:flex-row",children:[m?null:e.jsxs(e.Fragment,{children:[e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(te,{variant:"secondary",className:"size-8 p-1 shadow-none",onClick:st,children:e.jsx(zt,{className:"size-4"})})})}),e.jsx(U,{children:y("toolbar.reorder_diagram")})]}),e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(te,{variant:"secondary",className:V("size-8 p-1 shadow-none",Ee||Me?"bg-pink-600 text-white hover:bg-pink-500 dark:hover:bg-pink-700 hover:text-white":""),onClick:()=>Ke(n=>!n),children:e.jsx(Zt,{className:"size-4"})})})}),e.jsx(U,{children:y("snap_to_grid_tooltip",{key:nt==="mac"?"⇧":"Shift"})})]})]}),e.jsx("div",{className:`transition-opacity duration-300 ease-in-out ${ot?"opacity-100":"opacity-0"}`,children:e.jsxs(G,{children:[e.jsx(W,{asChild:!0,children:e.jsx("span",{children:e.jsx(te,{variant:"default",className:"size-8 p-1 shadow-none",onClick:at,children:e.jsx(Yt,{className:"size-4 text-white"})})})}),e.jsx(U,{children:y("toolbar.highlight_overlapping_tables")})]})})]})}),tt?e.jsx(ge,{position:"top-center",orientation:"horizontal",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsx(Pt,{variant:"default",className:"bg-pink-600 text-white",children:y("loading_diagram")})}):null,!$&&!m?e.jsx(ge,{position:"bottom-left",orientation:"horizontal",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsx(te,{className:"size-11 bg-pink-600 p-2 hover:bg-pink-500",onClick:L,children:e.jsx(Ft,{})})}):null,e.jsx(ge,{position:$?"bottom-center":"top-center",orientation:"horizontal",showZoom:!1,showFitView:!1,showInteractive:!1,className:"!shadow-none",children:e.jsx(cs,{readonly:m})}),Z&&e.jsx(Ht,{style:{width:$?100:60,height:$?100:60}}),e.jsx(At,{variant:Bt.Dots,gap:16,size:1})]}),e.jsx(hs,{})]})})};export{ks as C,je as S,Wt as a};
